<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Slide Story</title>
    <link rel="stylesheet" href="./style.css" />
</head>
<body>
    
        <h1>Welcome to Video Story</h1>

        <div class="video-main-list">
          
        </div>

        
</body>
</html>

<script src="./config.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', function(){
        LoadDataConfig();
    })
    
    function LoadDataConfig(){
        const mainContainer = document.querySelector('.video-main-list');
        const storyListContainer = document.createElement('div')
        storyListContainer.className = 'video-storyListContainer'; 
        mainContainer.appendChild(storyListContainer); 

        const storyPopupElement = document.createElement('div');
        storyPopupElement.className = 'story_main_popup';
        mainContainer.appendChild(storyPopupElement)

        function createPopupElement(data, index){
            let currentIndex = index;
            let videoIndex = 0;
            
            function renderProgressBar(blockCount){
                let progressBarHtml = '<div class="story_progressBar">';            
                for (let i = 0; i < blockCount; i++) {
                    progressBarHtml += '<div class="story_progressBarBlock"><div class="story_actualProgress">&nbsp;</div></div>';
                }
                progressBarHtml += '</div>';

                return progressBarHtml;
            }

            function renderProgressBaronNav(count) {
                let ProgressBar = document.querySelector('.story_progressBar')
                ProgressBar.innerHTML = ''
                let child = '<div class="story_progressBarBlock"><div class="story_actualProgress">&nbsp;</div></div>'
                for(let j=0; j<count; j++) {
                    ProgressBar.insertAdjacentHTML('beforeend', child)
                }
            }

            function renderVideos(dataIndex, videoIndex){
                return `<source src="${dataIndex[videoIndex]}" type="video/mp4">`
            }

            function renderVideoonNav(source){
                const videoSrc = document.querySelector('.story_image')
                videoSrc.load();
                videoSrc.querySelector('source').setAttribute('src', source)
            }
            const storyPopupHtml = `<div class="story_popupContainer">
                                        <div class="story_exitButton">
                                            <img src="./iconexit.svg" alt="exit" />
                                        </div> 
                                        <div class="story_imageContainer">
                                            <div class="story_headerHelper"></div> 
                                            <div class="story_storyHeader">
                                                ${renderProgressBar(data.stories.length)}
                                                <div class="story_storyInfo">
                                                    <img class="story_storyInfoImage" src="${data.thumbnail}" alt=""> 
                                                    <p class="story_headerText">${data.title}</p>
                                                </div>
                                            </div> 
                                            <div class="story_storyBodyContainer">
                                                <div class="video_container">
                                                    <video class="story_image" autoplay playsinline>
                                                        ${renderVideos(data.stories, 0)}
                                                    </video>  
                                                </div>
                                            </div> 
                                            <div class="story_chevronButton story_chevronButtonLeft">
                                                <img src="./iconLeft.svg" alt="iconLeft"/>
                                            </div> 
                                            <div class="story_chevronButton story_chevronButtonRight">
                                                <img src="./iconRight.svg" alt="iconRight" />
                                            </div>   
                                        </div>
                                    </div>`;
            
            storyPopupElement.innerHTML = storyPopupHtml;
            if(currentIndex < 1) {
                storyPopupElement.querySelector('.story_chevronButtonLeft').setAttribute('disabled', true)
            }
            
            const exitButton = document.querySelector('.story_exitButton');

            exitButton.addEventListener('click', function(){
                storyPopupElement.innerHTML = ''
            })

            function setHeight(){
                const wrapper = document.querySelector('.story_imageContainer')
                const videoImage = document.querySelector('.story_image');

                
            }
            function setProgressBarLoading(videoIndex){
                // Get the video element
                const video = document.querySelector('.story_image');
                
                // Get the progress bar and actual progress elements
                const progressBar = document.querySelectorAll('.story_progressBarBlock');
                const actualProgress = progressBar[videoIndex].querySelector('.story_actualProgress');
                
                for(i=0; i<videoIndex; i++) {
                    progressBar[i].classList.add('story_progressBarBlockPassed')
                }

                // Update the progress bar width on timeupdate event of the video
                video.addEventListener('timeupdate', () => {
                    // Calculate the progress percentage
                    const progress = (video.currentTime / video.duration) * 100;

                    if(progress >=100) {
                        moveNextSlide()
                    }
                    // Set the width of the actual progress bar
                    actualProgress.style.width = `${progress}%`;
                });
                
            }
            
            setProgressBarLoading(videoIndex)
            function movePrevSlide(){
                storyNextBtn.removeAttribute('disabled');
                if (videoIndex > 0) {
                    // If videoIndex is greater than 0, decrement it
                    videoIndex--;
                } else {
                    // If videoIndex is 0, check if currentIndex is greater than 0
                    if (currentIndex > 0) {
                        // Move to the previous index
                        currentIndex--;

                        // Set videoIndex to the last index of the previous section
                        const previousVideosLength = dataConfig[currentIndex].stories.length;
                        videoIndex = previousVideosLength - 1;
                    } else {
                        // Handle the case when currentIndex is already at 0
                        storyPrevBtn.setAttribute('disabled', true);
                        console.log("Already at the first element.");
                        return; // Optionally, you can choose what to do when at the first element
                    }
                }

                // Render the video based on the updated currentIndex and videoIndex
                renderProgressBaronNav(dataConfig[currentIndex].stories.length)
                renderVideoonNav(dataConfig[currentIndex]['stories'][videoIndex]);
                setProgressBarLoading(videoIndex)
            }

            function moveNextSlide(){
                storyPrevBtn.removeAttribute('disabled');
                const currentVideosLength = dataConfig[currentIndex].stories.length;
                if (videoIndex < currentVideosLength - 1) {
                    // If videoIndex is less than the last index in config array, increment it
                    videoIndex++;
                } else {
                    // If videoIndex is at the last index, check config length
                    if (currentVideosLength > 1) {
                        // If config length is greater than 1, move to the next index
                        currentIndex++;
                        videoIndex = 0;
                    } else {
                        // If config length is 1, just increment currentIndex
                        currentIndex++;
                    }
                }
                const isLastConfig = currentIndex === dataConfig.length - 1 && videoIndex === currentVideosLength - 1;
                renderVideoonNav(dataConfig[currentIndex]['stories'][videoIndex])                
                renderProgressBaronNav(dataConfig[currentIndex].stories.length)
                setProgressBarLoading(videoIndex)
                if (isLastConfig) {
                    storyNextBtn.setAttribute('disabled', true);
                } 
                
            }
            const storyPrevBtn = document.querySelector('.story_chevronButtonLeft');
            const storyNextBtn = document.querySelector('.story_chevronButtonRight');

            storyPrevBtn.addEventListener('click', function(){
                movePrevSlide()
            })

            storyNextBtn.addEventListener('click', function(){
                moveNextSlide()
            })

            window.addEventListener('resize', function(){
                setHeight();
            })
        }
        

        // Iterate through the dataConfig array
        dataConfig.forEach((data, index) => {
            // Create a circle container
            const circleContainer = document.createElement('div');
            circleContainer.className = 'video-circleContainer';

            // Create the circle border
            const circleBorder = document.createElement('div');
            circleBorder.className = 'video-circleBorder';

            // Create the image container
            const imageContainer = document.createElement('div');
            imageContainer.className = 'video-imageContainer';

            // Create the image element
            const image = document.createElement('img');
            image.className = 'video-imageThumbnail';
            image.src = data.thumbnail;
            image.alt = 'thumbnail';

            // Append the image to the image container
            imageContainer.appendChild(image);

            // Append the image container to the circle border
            circleBorder.appendChild(imageContainer);

            // Create the title element
            const title = document.createElement('p');
            title.className = 'video-circleTitle';
            title.textContent = data.title;

            // Append the title and circle border to the circle container
            circleContainer.appendChild(circleBorder);
            circleContainer.appendChild(title);

            // Append the circle container to the main container
            mainContainer.querySelector('.video-storyListContainer').appendChild(circleContainer);

            circleContainer.addEventListener('click', function(){
                createPopupElement(data, index)
            });
           
        });
    }
    
</script>