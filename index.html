<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Slide Story</title>
    <link rel="stylesheet" href="./style.css" />
</head>
<body>
    
        <h1>Welcome to Video Story</h1>

        <div class="video-main-list">
          
        </div>

        
</body>
</html>

<script src="./config.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', function(){
        LoadDataConfig();
    })
    
    function LoadDataConfig(){
        const mainContainer = document.querySelector('.video-main-list');
        const storyListContainer = document.createElement('div')
        storyListContainer.className = 'video-storyListContainer'; 
        mainContainer.appendChild(storyListContainer); 

        const storyPopupElement = document.createElement('div');
        storyPopupElement.className = 'story_main_popup';
        mainContainer.appendChild(storyPopupElement)

        function createPopupElement(data, index){
            let currentIndex = index;
            let videoIndex = 0;
            
            function renderProgressBar(blockCount){
                let progressBarHtml = '<div class="story_progressBar">';            
                for (let i = 0; i < blockCount; i++) {
                    progressBarHtml += '<div class="story_progressBarBlock"><div class="story_actualProgress">&nbsp;</div></div>';
                }
                progressBarHtml += '</div>';

                return progressBarHtml;
            }

            function renderVideos(dataIndex, videoIndex){
                return `<source src="${dataIndex[videoIndex]}" type="video/mp4">`
            }

            function renderVideoonNav(source){
                const videoSrc = document.querySelector('.story_image')
                videoSrc.load();
                videoSrc.querySelector('source').setAttribute('src', source)
            }
            const storyPopupHtml = `<div class="story_popupContainer">
                                        <div class="story_exitButton">
                                            <img src="./iconexit.svg" alt="exit" />
                                        </div> 
                                        <div class="story_imageContainer">
                                            <div class="story_headerHelper"></div> 
                                            <div class="story_storyHeader">
                                                ${renderProgressBar(data.stories.length)}
                                                <div class="story_storyInfo">
                                                    <img class="story_storyInfoImage" src="${data.thumbnail}" alt=""> 
                                                    <p class="story_headerText">${data.title}</p>
                                                </div>
                                            </div> 
                                            <div class="story_storyBodyContainer">
                                                <div class="story_imageContainer">
                                                    <video class="story_image" autoplay playsinline>
                                                        ${renderVideos(data.stories, 0)}
                                                    </video>  
                                                </div>
                                            </div> 
                                            <div class="story_chevronButton story_chevronButtonLeft">
                                                <img src="./iconLeft.svg" alt="iconLeft"/>
                                            </div> 
                                            <div class="story_chevronButton story_chevronButtonRight">
                                                <img src="./iconRight.svg" alt="iconRight" />
                                            </div>   
                                        </div>
                                    </div>`;
            
            storyPopupElement.innerHTML = storyPopupHtml;

            const exitButton = document.querySelector('.story_exitButton');

            exitButton.addEventListener('click', function(){
                storyPopupElement.innerHTML = ''
            })

            function setProgressBarLoading(videoIndex){
                // Get the video element
                const video = document.querySelector('.story_image');

                // Get the progress bar and actual progress elements
                const progressBar = document.querySelectorAll('.story_progressBarBlock');
                const actualProgress = progressBar[videoIndex].querySelector('.story_actualProgress');
                
                for(i=0; i<videoIndex; i++) {
                    progressBar[videoIndex - 1].classList.add('story_progressBarBlockPassed')
                }

                // Update the progress bar width on timeupdate event of the video
                video.addEventListener('timeupdate', () => {
                    // Calculate the progress percentage
                    const progress = (video.currentTime / video.duration) * 100;

                    // Set the width of the actual progress bar
                    actualProgress.style.width = `${progress}%`;
                });
                
            }
            

            
            setProgressBarLoading(videoIndex)
            function movePrevSlide(){
                storyNextBtn.setAttribute('disabled', false)
                if (currentIndex > 0) {
                    currentIndex = (currentIndex - 1) % dataConfig.length;
                } 
                if (currentIndex === 0) {
                    storyPrevBtn.setAttribute('disabled', true);
                }
                if(dataConfig[currentIndex]['stories'].length > 1){
                    renderVideoonNav(dataConfig[currentIndex]['stories'][0])
                } else {
                    renderVideoonNav(dataConfig[currentIndex]['stories'])
                }
            }

            function moveNextSlide(){
                const currentVideosLength = dataConfig[currentIndex].stories.length;
                if (videoIndex < currentVideosLength - 1) {
                    // If videoIndex is less than the last index in config array, increment it
                    videoIndex++;
                } else {
                    // If videoIndex is at the last index, check config length
                    if (currentVideosLength > 1) {
                        // If config length is greater than 1, move to the next index
                        currentIndex++;
                        videoIndex = 0;
                    } else {
                        // If config length is 1, just increment currentIndex
                        currentIndex++;
                    }
                }
                const isLastConfig = currentIndex === dataConfig.length - 1 && videoIndex === currentVideosLength - 1;
                renderVideoonNav(dataConfig[currentIndex]['stories'][videoIndex])
                if (isLastConfig) {
                    storyNextBtn.setAttribute('disabled', true);
                } 
            }
            const storyPrevBtn = document.querySelector('.story_chevronButtonLeft');
            const storyNextBtn = document.querySelector('.story_chevronButtonRight');

            storyPrevBtn.addEventListener('click', function(){
                movePrevSlide()
            })

            storyNextBtn.addEventListener('click', function(){
                moveNextSlide()
            })
        }
        

        // Iterate through the dataConfig array
        dataConfig.forEach((data, index) => {
            // Create a circle container
            const circleContainer = document.createElement('div');
            circleContainer.className = 'video-circleContainer';

            // Create the circle border
            const circleBorder = document.createElement('div');
            circleBorder.className = 'video-circleBorder';

            // Create the image container
            const imageContainer = document.createElement('div');
            imageContainer.className = 'video-imageContainer';

            // Create the image element
            const image = document.createElement('img');
            image.className = 'video-imageThumbnail';
            image.src = data.thumbnail;
            image.alt = 'thumbnail';

            // Append the image to the image container
            imageContainer.appendChild(image);

            // Append the image container to the circle border
            circleBorder.appendChild(imageContainer);

            // Create the title element
            const title = document.createElement('p');
            title.className = 'video-circleTitle';
            title.textContent = data.title;

            // Append the title and circle border to the circle container
            circleContainer.appendChild(circleBorder);
            circleContainer.appendChild(title);

            // Append the circle container to the main container
            mainContainer.querySelector('.video-storyListContainer').appendChild(circleContainer);

            circleContainer.addEventListener('click', function(){
                createPopupElement(data, index)
            });
           
        });
    }
    
</script>